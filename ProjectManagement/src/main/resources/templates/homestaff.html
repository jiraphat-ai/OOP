<!DOCTYPE html>
<html> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sunflower:wght@500&display=swap" rel="stylesheet">
    <script src="jquery-3.7.1.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <title>homestaff</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family:  Sunflower, sans-serif;
            background: linear-gradient(to right, #1F2863, #003b7a); 
            color: #000000; /* สีข้อความ */
        
        }

        .sidebar {
    /* padding: 20px; */
    width: 250px;
    /* height: 100vh; */
    /* background-color: #fff; */
    position: flex;
    left: 0;
    top: 0;
    /* padding-top: 20px; */
}

        .profile {
            display: flex;
            align-items: center;
        }

        .profile img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .profile .staff {
            font-weight: bold;
        }

        .menu {
            margin-bottom: 20px;
        }

        .menu ul {
            list-style-type: none;
            padding: 0;
        }

        .menu ul li {
            margin-bottom: 10px;
        }

        .menu ul li a {
            display: block;
            padding: 5px;
            background-color: transparent;
            border: none;
            color: inherit;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .menu ul li a:hover {
            background-color: #f1f1f1;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: center; /* แก้ตรงนี้ */
            align-items: center;
            margin-bottom: 20px;
        }

        .header h2 {
            margin: 0;
        }

        .search {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }

        .search input[type="text"] {
            margin-right: 10px;
        }

        .search button {
            background-color: green;
            color: white;
            border: none;
            padding: 5px 10px;
        }

        .add-user {
            margin-bottom: 20px;
            margin-left: 20px; /* Adjusted margin */
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid black; /* Add this line */
        }

        .user-table th,
        .user-table td {
            padding: 10px;
            border: 1px solid black;
        }

        .user-table th {
            background-color: #f1f1f1;
        }

        .user-table td button {
            margin-right: 5px;
        }

        .white-frame {
            width: auto;
            height: 199px;
            background-color: #fff;
            padding: 20px;
            border: 1px solid black; /* Add this line */
            border-radius: 5px; /* Add this line */
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3); /* Add this line */
        }
    </style>
</head>
<body>
    <div class="row" >
    <div class="d-flex flex-column flex-shrink-0 p-3 col-2 bg-light" style="width: 280px;">
        <div class="sidebar">
            <div class="profile">
                <a href="#" class="d-flex align-items-center link-dark text-decoration-none ">
                    <img src="https://cdn-icons-png.flaticon.com/512/3884/3884871.png" alt="" width="40" height="40"
                        class="rounded-circle me-2">
                    <strong> STAFF <br> <div th:text="${session.firstName} + ' ' + ${session.lastName}"> </div></strong>
                </a>
            </div>
        </div>
        <hr>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="/homestaff" class="nav-link active" aria-current="page">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-person-add" viewBox="0 0 16 16">
                        <path
                            d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7m.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0m-2-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0M8 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4" />
                        <path
                            d="M8.256 14a4.5 4.5 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10q.39 0 .74.025c.226-.341.496-.65.804-.918Q8.844 9.002 8 9c-5 0-6 3-6 4s1 1 1 1z" />
                    </svg>
                    User
                </a>
            </li>
            <li>
                <a href="/createsubject" class="nav-link link-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-book-fill" viewBox="0 0 16 16">
                        <path
                            d="M8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783" />
                    </svg>
                    Subject
                </a>
            </li>
            <li>
                <a href="/importsubjectfile" class="nav-link link-dark">
                    <img src="https://cdn3.iconfinder.com/data/icons/interaction-design/512/Import_B-512.png" alt="" width="16" height="16">
                    Create New Subject
                </a>
            </li>
            <li>
                <a href="/importuserfile" class="nav-link link-dark">
                    <img src="https://cdn3.iconfinder.com/data/icons/interaction-design/512/Import_B-512.png" alt=""
                        width="16" height="16">
                    Create New User
                </a>
            <li>
                <a href="/logout" class="nav-link link-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
                        class="bi bi-box-arrow-right" viewBox="0 0 16 16">
                        <path fill-rule="evenodd"
                            d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
                        <path fill-rule="evenodd"
                            d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
                    </svg>
                    Log Out
                </a>
            </li>

        </ul>
        <hr>
    </div>
    <!-- <div class="sidebar">
        <div class="profile">
            <img src="profile.jpg" alt="Profile Picture">
            <div>
                <div class="staff">Staff</div>
                <div>First Last</div>
            </div>
        </div>
        <div class="menu">
            <ul>
                <li><a href="#">User</a></li>
                <li><a href="#">Subject</a></li>
                <li><a href="#">Create New Subject</a></li>
                <li><a href="#">Create New Account</a></li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </div>
    </div> -->
    <div class="content col-9">
        <div class="white-frame">
            <div class="header">
                <h2 class="display-4">All Users</h2>
            </div>
            <div class="search">
                <input type="text" class="form-control" id="usernameInput" placeholder="Username">
                <input type="text" class="form-control" id="nameInput" placeholder="Name">
                <button class="btn btn-primary" onclick="searchUsername()">Search</button>
            </div>
        </div>
        <div class="add-user mt-3">
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button>
        </div>

        <select name="sortOption" id="sortsearch">
            <option value="#">Default</option>
            <option value="groupNameAtoZ">Sort by Username A-Z</option>
            <option value="groupNameZtoA">Sort by Username Z-A</option>
        </select>

        <!-- Modal -->
        <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                                        <div class="modal-body">
                                            <form>
                                                <div class="mb-3">
                                                    <label for="username" class="form-label">Username</label>
                                                    <input type="text" class="form-control" id="username" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="password" class="form-label">Password</label>
                                                    <input type="password" class="form-control" id="password" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="firstName" class="form-label">First Name</label>
                                                    <input type="text" class="form-control" id="firstName" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="lastName" class="form-label">Last Name</label>
                                                    <input type="text" class="form-control" id="lastName" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="userType" class="form-label">User Type</label>
                                                    <select class="form-select" id="userType" required>
                                                        <option value="student">Student</option>
                                                        <option value="staff">Staff</option>
                                                    </select>
                                                </div>
                                            </form>
                                        </div>

                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="button" class="btn btn-primary" onclick="addUserToFirestore()">Save changes</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete this user?</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button type="button" id="modal_btn_del" class="btn btn-danger" onclick="deleteUserInFirestore()">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        <div class="bg-white p-3">
                            <table class="table" id="user-table">
                                <thead>
                                    <tr class="bg-primary text-white">
                                        <!-- Change "studentId" to "username" and update other column names accordingly -->
                                        <th>Username</th>
                                        <th>First Name</th>
                                        <th>Last Name</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white" >
                                <tr th:each="user : ${users}">
                                    <td th:text="${user['username']}"></td>
                                    <td th:text="${user['firstName']}"></td>
                                    <td th:text="${user['lastName']}"></td>
                                    <td>
                                        <button type="button" class="btn btn-danger"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteUserModal"
                                                onclick="setUsernameForDeleteUserModal(this)">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                                    <!-- Add more rows here -->
                                </tbody>
                            </table>
                        </div>
                        </div>
                    </div>
                        <script th:inline="javascript">
                            /*<![CDATA[*/
                            function deleteUser(username) {
                                fetch('/deleteUser', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({ username: username }),
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            alert('User deleted successfully');
                                            location.reload();
                                        } else {
                                            alert('Error deleting user: ' + data.message);
                                        }
                                    })
                                    .catch((error) => {
                                        console.error('Error:', error);
                                    });
                            }
                            /*]]>*/
                        </script>
                        <script>
                            $(document).ready(function() {
                                // Check if the table exists
                                if ($('.table').length) {
                                    // Initialize DataTable
                                    $('.table').DataTable({

                                    });
                                } else {
                                    console.error('Table #user-table does not exist');
                                }
                            });
                            function addUserToFirestore() {
                                const username = document.getElementById('username').value;
                                const password = document.getElementById('password').value;
                                const firstName = document.getElementById('firstName').value;
                                const lastName = document.getElementById('lastName').value;
                                const userType = document.getElementById('userType').value;

                                const formData = new FormData();
                                formData.append('username', username);
                                formData.append('password', password);
                                formData.append('firstName', firstName);
                                formData.append('lastName', lastName);
                                formData.append('userType', userType);

                                fetch('/addUser', {
                                    method: 'POST',
                                    body: formData,
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Network response was not ok');
                                        }
                                        return response.json();
                                    })
                                    .then(data => {
                                        if (data.success) {
                                            alert('User added successfully');
                                            location.reload(); // Refresh the page after adding a user
                                        } else {
                                            alert('Error adding user: ' + data.message);
                                        }
                                    })

                                    .catch(error => {
                                        console.error('Error:', error);
                                    });
                            }

                            function setUsernameForDeleteUserModal(element) {
                                $(element).parent().each(function () {
                                    const username = $(this).siblings().first().text();
                                    console.log("username");
                                    document.getElementById('deleteUserModalLabel').innerText = `Delete User - ${username}`;
                                    $('#modal_btn_del').attr('onclick', `deleteUser('${username}')`);
                                });
                            }
                            
                          
                            function searchUsername() {
                                    // Get the values from the input fields
                                    var username = document.getElementById('usernameInput').value.trim().toLowerCase();
                                    var name = document.getElementById('nameInput').value.trim().toLowerCase();

                                    // Get all rows in the table
                                    var rows = document.querySelectorAll('tbody tr');

                                    // Loop through each row and check if it matches the search criteria
                                    rows.forEach(function (row) {
                                        var rowUsername = row.querySelector('td:nth-child(1)').innerText.trim().toLowerCase();
                                        var rowFirstName = row.querySelector('td:nth-child(2)').innerText.trim().toLowerCase();
                                        var rowLastName = row.querySelector('td:nth-child(3)').innerText.trim().toLowerCase();

                                        // Check if the row matches the search criteria
                                        var matchUsername = rowUsername.includes(username);
                                        var matchName = rowFirstName.includes(name) || rowLastName.includes(name);

                                        // Show/hide the row based on the search criteria
                                        row.style.display = (matchUsername && matchName) ? '' : 'none';
                                    });
                                }
                                    function updateTable(data) {
                                        // Get the table
                                        var table = document.getElementById("user-table");

                                        // Remove all rows from the table
                                        while (table.rows.length > 1) {
                                            table.deleteRow(1);
                                        }

                                        // Add new rows to the table
                                        for (var i = 0; i < data.length; i++) {
                                            var row = table.insertRow(-1);
                                            var cell1 = row.insertCell(0);
                                            var cell2 = row.insertCell(1);
                                            // Add more cells if you have more columns

                                            cell1.innerHTML = data[i].username;
                                            cell2.innerHTML = data[i].firstName;
                                            // Set the cell values to the data values
                                        }
                                    }
                                    $(document).ready(function() {
                                        $("#sortsearch").change(function() {
                                            var sortOption = $(this).val();
                                            console.log("sortlog:", sortOption);
                                            sortMembers(sortOption);
                                        });

                                        function sortMembers(order) {
                                            let section = $('#section').val();
                                            let tag = [];
                                            $('#tag input:checked').each(function() {
                                                tag.push($(this).val());
                                            });
                                            tag = tag.join(','); // Convert the array to a comma-separated string

                                            $.ajax({
                                                url: '/sortMembers',
                                                type: 'GET',
                                                data: {
                                                    section: section,
                                                    tag: tag,
                                                    order: order
                                                },
                                                success: function(data) {
                                                    let table = $(data).find('#user-table');
                                                    $('#user-table').replaceWith(table);
                                                }
                                            });
                                        }
                                    });
                        </script>
                    </body>
                    </html>
